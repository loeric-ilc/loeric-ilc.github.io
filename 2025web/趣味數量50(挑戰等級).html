<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶£å‘³æ•¸é‡50ç·´ç¿’ (é€æ˜å›é¥‹ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #f0f8ff;
            --btn-color: #4e73df;
            --highlight-bg: rgba(255, 230, 0, 0.6);
            --user-counted-bg: #d1e7dd; 
            --number-badge-color: #ff4757;
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden; /* é˜²æ­¢æ•´å€‹ç¶²é æ²å‹• */
            position: relative;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .active { display: flex; }

        h1 { color: #333; margin-bottom: 30px; }
        
        /* --- å…¨è¢å¹• O / X é®ç½© (ä¿®æ”¹ï¼šèƒŒæ™¯é€æ˜) --- */
        #overlay-feedback {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999; /* æœ€ä¸Šå±¤ */
            display: none; /* é è¨­éš±è— */
            justify-content: center;
            align-items: center;
            font-size: 30rem; /* å­—é«”æ”¾å¤§ */
            font-weight: bold;
            
            /* é è¨­é€æ˜èƒŒæ™¯ */
            background-color: transparent; 
            
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none; /* è®“é»æ“Šå¯ä»¥ç©¿é€ (é›–ç„¶é¡¯ç¤ºæ™‚é€šå¸¸ä¸é»æ“Š) */
        }

        /* ç­”å°ï¼šç¶ è‰²åœˆåœˆï¼Œç„¡èƒŒæ™¯ï¼ŒåŠ ç™½é‚Šå‡¸é¡¯ */
        .overlay-correct {
            color: #28a745; 
            text-shadow: 0 0 30px rgba(255, 255, 255, 1), 4px 4px 10px rgba(0,0,0,0.2);
        }

        /* ç­”éŒ¯ï¼šç´…è‰²å‰å‰ï¼Œç„¡èƒŒæ™¯ï¼ŒåŠ ç™½é‚Šå‡¸é¡¯ */
        .overlay-wrong {
            color: #dc3545;
            text-shadow: 0 0 30px rgba(255, 255, 255, 1), 4px 4px 10px rgba(0,0,0,0.2);
        }

        /* --- é¸å–®æŒ‰éˆ• --- */
        .menu-btn {
            background-color: white;
            border: 2px solid var(--btn-color);
            color: var(--btn-color);
            padding: 15px 40px;
            margin: 10px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            width: 280px;
        }

        .menu-btn:hover {
            background-color: var(--btn-color);
            color: white;
        }

        #status-bar {
            width: 90%;
            max-width: 900px;
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #feedback {
            margin: 5px 0;
            font-size: 1.5rem;
            font-weight: bold;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            transition: all 0.3s ease;
        }

        .feedback-large {
            font-size: 3.5rem !important;
            color: var(--btn-color) !important;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        /* --- é¡¯ç¤ºå€åŸŸè¨­å®š (çµ•å°ä¸æ²å‹•) --- */
        #display-area {
            width: 95%;
            max-width: 1050px;
            height: 90vh; /* å›ºå®šé«˜åº¦å€åŸŸ */
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 15px;
            
            display: grid;
            /* é€™è£¡çš„ columns ç”± JS å‹•æ…‹æ§åˆ¶ */
            gap: 2px; /* é–“è·ç¸®å°ä»¥å¡å…¥æ›´å¤š */
            
            /* å…§å®¹å‚ç›´ç½®ä¸­ï¼Œä¸”ä¸ç”¢ç”Ÿæ²è»¸ */
            align-content: center; 
            //justify-items: center;
            overflow: hidden; 
        }

        .item {
            /* å­—é«”å¤§å°ç”± JS å‹•æ…‹æ§åˆ¶ */
            font-size: 3rem; 
            width: 100%;
            height: 100%; /* å¡«æ»¿æ ¼å­ */
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            position: relative;
            cursor: pointer;
            line-height: 1; 
            transition: transform 0.1s;
        }

        .item:active { transform: scale(0.9); }

        .counting-highlight {
            background-color: var(--highlight-bg);
            transform: scale(1.2) !important;
            z-index: 100;
            box-shadow: 0 0 10px gold;
            border-radius: 50%;
        }

        .user-counted {
            background-color: var(--user-counted-bg);
            border: 2px solid #a3cfbb;
            border-radius: 50%;
        }

        /* å³ä¸Šè§’ç´…è‰²è¨ˆæ•¸çƒ */
        .item::after {
            content: attr(data-count);
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--number-badge-color);
            color: white;
            /* ä½¿ç”¨ em å–®ä½ï¼Œéš¨ emoji å¤§å°ç¸®æ”¾ */
            font-size: 0.35em; 
            width: 1.6em;
            height: 1.6em;
            border-radius: 50%;
            display: none; /* é è¨­éš±è— */
            justify-content: center;
            align-items: center;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            animation: popIn 0.3s;
            z-index: 101;
        }

        .item[data-count]::after { display: flex; }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        #options-area {
            margin-top: 15px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            height: 15vh;
            align-items: center;
        }

        .option-btn {
            background-color: var(--btn-color);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 15px 90px;
            min-width: 140px;
            height: 140px;
            font-size: 8rem;
            cursor: pointer;
            box-shadow: 0 4px 0 #2e59d9;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .option-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .option-btn:disabled { 
            background-color: #ddd; 
            box-shadow: none; 
            color: #999; 
            cursor: not-allowed; 
            opacity: 0.8; 
        }
        
        .suggest-correct {
            background-color: #28a745 !important;
            transform: scale(1.1);
            box-shadow: 0 0 15px #28a745 !important;
            animation: pulse 1.5s infinite;
            z-index: 50;
        }

        @keyframes pulse {
            0% { transform: scale(1.1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1.1); }
        }

        .final-score { font-size: 4rem; color: #e74a3b; font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>

    <div id="overlay-feedback"></div>

    <div id="menu-screen" class="screen active">
        <h1>è«‹é¸æ“‡æŒ‘æˆ°ç­‰ç´š</h1>
        <button class="menu-btn" onclick="startGame(1, 5)">è¶…åˆç´š (1 ~ 5)</button>
        <button class="menu-btn" onclick="startGame(1, 10)">åˆç´š (1 ~ 10)</button>
        <button class="menu-btn" onclick="startGame(11, 20)">ä¸­ç´š (11 ~ 20)</button>
        <button class="menu-btn" onclick="startGame(21, 30)">é«˜ç´š (21 ~ 30)</button>
        <button class="menu-btn" onclick="startGame(31, 40)">æŒ‘æˆ° (31 ~ 40)</button>
        <button class="menu-btn" onclick="startGame(41, 50)">å¤§å¸« (41 ~ 50)</button>
    </div>

    <div id="game-screen" class="screen">
        <div id="status-bar">
            <span id="score-display">å¾—åˆ†: 0</span>
            <span id="progress-display">é¡Œç›®: 1 / 10</span>
        </div>
        <div id="feedback">è«‹ç”¨æ‰‹é»ä¸€é»ï¼Œæ•¸æ•¸çœ‹æœ‰å¤šå°‘ï¼Ÿ</div>
        
        <div id="display-area"></div>
        
        <div id="options-area"></div>
    </div>

    <div id="result-screen" class="screen">
        <h1>æŒ‘æˆ°å®Œæˆï¼</h1>
        <div>æ‚¨çš„å¾—åˆ†æ˜¯</div>
        <div class="final-score" id="final-score-text">100</div>
        <button class="menu-btn" onclick="showMenu()">å›é¦–é </button>
    </div>

    <script>
        const TOTAL_QUESTIONS_PER_ROUND = 10;
        
        const categories = {
            stationery: ['âœï¸', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–Šï¸', 'ğŸ““', 'ğŸ“'],
            fruit: ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸŠ', 'ğŸ“', 'ğŸ‘'],
            others: ['ğŸ€', 'ğŸš—', 'ğŸˆ', 'â­', 'ğŸ§¸', 'ğŸš²', 'ğŸ¶', 'ğŸ±', 'ğŸ¢']
        };

        let currentLevelMin = 1;
        let currentLevelMax = 10;
        let currentQuestionIndex = 0;
        let currentScore = 0;
        
        let currentCount = 0;
        let userClickCount = 0;
        let isSystemGuiding = false;
        let isAnswered = false; 
        let isRetryMode = false;

        const synth = window.speechSynthesis;
        const overlay = document.getElementById('overlay-feedback');

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showMenu() {
            showScreen('menu-screen');
        }

        function startGame(min, max) {
            currentLevelMin = min;
            currentLevelMax = max;
            currentQuestionIndex = 0;
            currentScore = 0;
            showScreen('game-screen');
            generateQuestion();
        }

        function updateStatusBar() {
            document.getElementById('score-display').innerText = `å¾—åˆ†: ${currentScore}`;
            document.getElementById('progress-display').innerText = `é¡Œç›®: ${currentQuestionIndex + 1} / ${TOTAL_QUESTIONS_PER_ROUND}`;
        }

        function endGame() {
            showScreen('result-screen');
            const finalScore = (currentScore / TOTAL_QUESTIONS_PER_ROUND) * 100;
            document.getElementById('final-score-text').innerText = Math.round(finalScore);
            let comment = finalScore === 100 ? "å¤ªå²å®³äº†ï¼" : "è¡¨ç¾å¾ˆæ£’å–”ï¼";
            speakSimple(`æŒ‘æˆ°å®Œæˆï¼Œ${comment}`);
        }

        function generateQuestion() {
            if (currentQuestionIndex >= TOTAL_QUESTIONS_PER_ROUND) {
                endGame();
                return;
            }

            updateStatusBar();
            synth.cancel();

            const displayArea = document.getElementById('display-area');
            const optionsArea = document.getElementById('options-area');
            const feedback = document.getElementById('feedback');
            
            displayArea.innerHTML = '';
            optionsArea.innerHTML = '';
            feedback.className = '';
            feedback.innerText = 'è«‹ç”¨æ‰‹é»ä¸€é»ï¼Œæ•¸æ•¸çœ‹æœ‰å¤šå°‘ï¼Ÿ';
            feedback.style.color = '#333';
            
            isSystemGuiding = false;
            isAnswered = false;
            isRetryMode = false;
            userClickCount = 0;

            // ç¢ºä¿ O/X é®ç½©æ˜¯éš±è—çš„
            overlay.style.display = 'none';
            overlay.className = '';

            currentCount = Math.floor(Math.random() * (currentLevelMax - currentLevelMin + 1)) + currentLevelMin;

            const categoryKeys = Object.keys(categories);
            const randomCategory = categoryKeys[Math.floor(Math.random() * categoryKeys.length)];
            const items = categories[randomCategory];
            const randomItemChar = items[Math.floor(Math.random() * items.length)];

            // --- ç²¾å¯†è¨ˆç®—ç‰ˆé¢ (ç¢ºä¿ä¸æ²å‹•) ---
            // é‚è¼¯ï¼šæ•¸é‡è¶Šå¤šï¼Œæ¬„æ•¸è¶Šå¤šï¼Œå­—é«”è¶Šå°
            let cols = 5;
            let fontSize = "8rem";

            if (currentCount <= 5) {
                cols = 5; fontSize = "7rem";
            } else if (currentCount <= 12) {
                cols = 4; fontSize = "6.5rem"; // 4x3
            } else if (currentCount <= 20) {
                cols = 5; fontSize = "5rem";   // 5x4
            } else if (currentCount <= 30) {
                cols = 6; fontSize = "4rem";   // 6x5
            } else if (currentCount <= 40) {
                cols = 8; fontSize = "3.2rem"; // 8x5
            } else {
                // 41-50
                cols = 10; fontSize = "2.8rem"; // 10x5
            }
            fontSize = "8rem";

            displayArea.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            for (let i = 0; i < currentCount; i++) {
                const div = document.createElement('div');
                div.classList.add('item');
                div.innerText = randomItemChar;
                div.style.fontSize = fontSize;
                div.id = `item-${i}`;
                div.onclick = function() { handleUserTap(div); };
                displayArea.appendChild(div);
            }

            // --- ç”¢ç”Ÿé¸é … ---
            let options = [currentCount];
            while (options.length < 3) {
                let offset = Math.floor(Math.random() * 9) - 4;
                let wrongOption = currentCount + offset;
                if (wrongOption > 0 && !options.includes(wrongOption)) {
                    options.push(wrongOption);
                }
            }
            options.sort(() => Math.random() - 0.5);

            options.forEach(num => {
                const btn = document.createElement('button');
                btn.classList.add('option-btn');
                btn.innerText = num;
                btn.setAttribute('data-val', num);
                btn.onclick = () => checkAnswer(btn, num);
                optionsArea.appendChild(btn);
            });
        }

        function handleUserTap(item) {
            if (isAnswered || isSystemGuiding) return;

            if (!item.classList.contains('user-counted')) {
                userClickCount++;
                item.classList.add('user-counted');
                item.setAttribute('data-count', userClickCount);
                speakSimple(userClickCount.toString());
            }
        }

        // --- é¡¯ç¤ºå…¨è¢å¹• O / X å‹•ç•«å‡½æ•¸ ---
        function showFullFeedback(isCorrect, callback) {
            overlay.style.display = 'flex';
            // å¼·åˆ¶é‡ç¹ªä»¥è§¸ç™¼ transition
            void overlay.offsetWidth;
            
            if (isCorrect) {
                overlay.className = 'overlay-correct';
                overlay.innerText = 'O';
                overlay.style.opacity = '1';
                speakSimple("å¤ªæ£’äº†ï¼Œç­”å°äº†");
            } else {
                overlay.className = 'overlay-wrong';
                overlay.innerText = 'âŒ';
                overlay.style.opacity = '1';
                // é€™è£¡å…ˆä¸å”¸èªéŸ³ï¼Œé¿å…è·Ÿ "ä¸å°å–”" è¡çª
            }

            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    if (callback) callback();
                }, 900); // ç­‰å¾…æ·¡å‡ºå‹•ç•«çµæŸ
            }, 2000); // é¡¯ç¤ºå¤šä¹…ï¼Œç¸®çŸ­ä¸€é»é¿å…ç­‰å¾…å¤ªä¹…
        }

        function checkAnswer(btn, selectedNum) {
            if (isSystemGuiding) return;
            
            // é‡è©¦æ¨¡å¼ä¸‹ç­”å°
            if (isAnswered && isRetryMode && selectedNum === currentCount) {
                handleCorrect(btn, false);
                return;
            }

            if (isAnswered) return;
            isAnswered = true; 

            if (selectedNum === currentCount) {
                handleCorrect(btn, true);
            } else {
                // --- ç­”éŒ¯æµç¨‹ ---
                showFullFeedback(false, function() {
                    // å…¨è¢å¹• X æ¶ˆå¤±å¾ŒåŸ·è¡Œï¼š
                    btn.classList.add('wrong'); // æŒ‰éˆ•è®Šç´…
                    document.getElementById('feedback').innerText = 'ä¸å°å–”ï¼Œæˆ‘å€‘ä¸€èµ·ä¾†æ•¸æ•¸çœ‹ï¼';
                    document.getElementById('feedback').style.color = '#dc3545';
                    
                    const errMsg = new SpeechSynthesisUtterance("ä¸å°å–”ï¼Œæˆ‘å€‘ä¸€èµ·ä¾†æ•¸æ•¸çœ‹");
                    errMsg.lang = 'zh-TW';
                    
                    errMsg.onend = function() {
                        startGuidedCounting();
                    };
                    synth.speak(errMsg);
                });
                
                // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ•¸
                const allItems = document.querySelectorAll('.item');
                allItems.forEach(item => {
                    item.classList.remove('user-counted');
                    item.removeAttribute('data-count');
                });
            }
        }

        function handleCorrect(btn, addScore) {
            const feedback = document.getElementById('feedback');
            
            // --- ç­”å°æµç¨‹ ---
            showFullFeedback(true, function() {
                // å…¨è¢å¹• O æ¶ˆå¤±å¾ŒåŸ·è¡Œï¼š
                btn.classList.add('suggest-correct'); // æŒ‰éˆ•ç™¼å…‰
                feedback.innerText = 'å¤ªæ£’äº†ï¼ç­”å°äº†ï¼';
                feedback.style.color = 'green';
                
                if (addScore) currentScore++;
                
                setTimeout(() => {
                    currentQuestionIndex++;
                    generateQuestion();
                }, 500);
            });
        }

        function startGuidedCounting() {
            isSystemGuiding = true;
            
            const buttons = document.querySelectorAll('.option-btn');
            const feedback = document.getElementById('feedback');
            
            buttons.forEach(b => b.disabled = true);
            feedback.classList.add('feedback-large');

            let count = 0;

            function playNext() {
                if (count >= currentCount) {
                    finishCounting();
                    return;
                }

                const currentItem = document.getElementById(`item-${count}`);
                if (currentItem) {
                    currentItem.classList.add('counting-highlight');
                    currentItem.setAttribute('data-count', count + 1);
                }

                feedback.innerText = count + 1;

                const utterance = new SpeechSynthesisUtterance((count + 1).toString());
                utterance.lang = 'zh-TW';
                utterance.rate = 1; 

                utterance.onend = function() {
                    if (currentItem) {
                        currentItem.classList.remove('counting-highlight');
                    }
                    count++;
                    setTimeout(playNext, 80);
                };

                synth.speak(utterance);
            }

            playNext();
            
            function finishCounting() {
                isSystemGuiding = false;
                isRetryMode = true;
                
                feedback.classList.remove('feedback-large');
                feedback.innerText = `å…±æœ‰ ${currentCount} å€‹ï¼Œè«‹é¸å‡ºæ­£ç¢ºçš„ç­”æ¡ˆï¼`;
                
                const finalMsg = new SpeechSynthesisUtterance(`å…±æœ‰ ${currentCount} å€‹ï¼Œè«‹é¸å‡ºæ­£ç¢ºçš„ç­”æ¡ˆ`);
                finalMsg.lang = 'zh-TW';
                synth.speak(finalMsg);

                buttons.forEach(b => {
                    const btnVal = parseInt(b.getAttribute('data-val'));
                    if (btnVal === currentCount) {
                        b.disabled = false;
                        b.classList.add('suggest-correct');
                    } else {
                        b.disabled = true;
                        if (!b.classList.contains('wrong')) {
                            b.style.opacity = '0.3';
                        }
                    }
                });
            }
        }

        function speakSimple(text) {
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            synth.speak(utterance);
        }

        window.onload = showMenu;

    </script>
</body>
</html>