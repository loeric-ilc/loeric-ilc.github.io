<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶£å‘³æ•¸é‡50ç·´ç¿’ (æŒ‘æˆ°ç­‰ç´š)</title>
    <style>
        :root {
            --bg-color: #f0f8ff;
            --btn-color: #4e73df;
            --highlight-bg: rgba(255, 230, 0, 0.6);
            --user-counted-bg: #d1e7dd; 
            --number-badge-color: #ff4757;
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .active { display: flex; }

        h1 { color: #333; margin-bottom: 30px; }
        
        .menu-btn {
            background-color: white;
            border: 2px solid var(--btn-color);
            color: var(--btn-color);
            padding: 15px 40px;
            margin: 10px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            width: 280px;
        }

        .menu-btn:hover {
            background-color: var(--btn-color);
            color: white;
        }

        #status-bar {
            width: 90%;
            max-width: 900px;
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #feedback {
            margin: 5px 0;
            font-size: 1.5rem;
            font-weight: bold;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            transition: all 0.3s ease;
        }

        .feedback-large {
            font-size: 3.5rem !important;
            color: var(--btn-color) !important;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        /* --- é¡¯ç¤ºå€åŸŸè¨­å®š (å›å¾©ç‚ºç´” Grid æ’åˆ—) --- */
        #display-area {
            width: 95%;
            max-width: 850px;
            height: 55vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 20px;
            
            /* ä½¿ç”¨ Grid å¼·åˆ¶ 10 æ¬„ï¼Œä½†æ²’æœ‰é¡å¤–çš„æ¡†æ¡† */
            display: grid;
            grid-template-columns: repeat(10, 1fr); 
            gap: 5px; 
            align-content: start; 
            justify-items: center;
            
            overflow-y: auto;
        }

        .item {
            font-size: 2rem;
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            position: relative;
            border-radius: 10px;
            transition: transform 0.1s;
            cursor: pointer;
        }

        .item:active { transform: scale(0.9); }

        .counting-highlight {
            background-color: var(--highlight-bg);
            transform: scale(1.2) !important;
            z-index: 100;
            box-shadow: 0 0 10px gold;
            border-radius: 50%;
        }

        .user-counted {
            background-color: var(--user-counted-bg);
            border: 2px solid #a3cfbb;
            border-radius: 50%;
        }

        .item::after {
            content: attr(data-count);
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--number-badge-color);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            animation: popIn 0.3s;
            z-index: 101;
        }

        .item[data-count]::after { display: flex; }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        #options-area {
            margin-top: 15px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .option-btn {
            background-color: var(--btn-color);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 10px 30px;
            min-width: 90px;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 0 #2e59d9;
            transition: all 0.3s;
        }

        .option-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .option-btn:disabled { 
            background-color: #ddd; 
            box-shadow: none; 
            color: #999; 
            cursor: not-allowed; 
            opacity: 0.6;
        }
        
        .correct { background-color: #28a745 !important; box-shadow: 0 4px 0 #1e7e34 !important; }
        .wrong { background-color: #dc3545 !important; box-shadow: 0 4px 0 #bd2130 !important; }

        .suggest-correct {
            background-color: #28a745 !important;
            transform: scale(1.2);
            box-shadow: 0 0 15px #28a745 !important;
            animation: pulse 1.5s infinite;
            z-index: 50;
        }

        @keyframes pulse {
            0% { transform: scale(1.2); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1.2); }
        }

        .final-score { font-size: 4rem; color: #e74a3b; font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>

    <div id="menu-screen" class="screen active">
        <h1>è«‹é¸æ“‡æŒ‘æˆ°ç­‰ç´š</h1>
        <button class="menu-btn" onclick="startGame(1, 5)">è¶…åˆç´š (1 ~ 5)</button>
        <button class="menu-btn" onclick="startGame(1, 10)">åˆç´š (1 ~ 10)</button>
        <button class="menu-btn" onclick="startGame(11, 20)">ä¸­ç´š (11 ~ 20)</button>
        <button class="menu-btn" onclick="startGame(21, 30)">é«˜ç´š (21 ~ 30)</button>
        <button class="menu-btn" onclick="startGame(31, 40)">æŒ‘æˆ° (31 ~ 40)</button>
        <button class="menu-btn" onclick="startGame(41, 50)">å¤§å¸« (41 ~ 50)</button>
    </div>

    <div id="game-screen" class="screen">
        <div id="status-bar">
            <span id="score-display">å¾—åˆ†: 0</span>
            <span id="progress-display">é¡Œç›®: 1 / 10</span>
        </div>
        <div id="feedback">è«‹ç”¨æ‰‹é»ä¸€é»ï¼Œæ•¸æ•¸çœ‹æœ‰å¤šå°‘ï¼Ÿ</div>
        
        <div id="display-area"></div>
        
        <div id="options-area"></div>
    </div>

    <div id="result-screen" class="screen">
        <h1>æŒ‘æˆ°å®Œæˆï¼</h1>
        <div>æ‚¨çš„å¾—åˆ†æ˜¯</div>
        <div class="final-score" id="final-score-text">100</div>
        <button class="menu-btn" onclick="showMenu()">å›é¦–é </button>
    </div>

    <script>
        const TOTAL_QUESTIONS_PER_ROUND = 10;
        
        const categories = {
            stationery: ['âœï¸', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–Šï¸', 'ğŸ““', 'ğŸ“'],
            fruit: ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸŠ', 'ğŸ“', 'ğŸ‘'],
            others: ['ğŸ€', 'ğŸš—', 'ğŸˆ', 'â­', 'ğŸ§¸', 'ğŸš²']
        };

        let currentLevelMin = 1;
        let currentLevelMax = 10;
        let currentQuestionIndex = 0;
        let currentScore = 0;
        
        let currentCount = 0;
        let userClickCount = 0;
        let isSystemGuiding = false;
        let isAnswered = false; 
        let isRetryMode = false;

        const synth = window.speechSynthesis;

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showMenu() {
            showScreen('menu-screen');
        }

        function startGame(min, max) {
            currentLevelMin = min;
            currentLevelMax = max;
            currentQuestionIndex = 0;
            currentScore = 0;
            showScreen('game-screen');
            generateQuestion();
        }

        function updateStatusBar() {
            document.getElementById('score-display').innerText = `å¾—åˆ†: ${currentScore}`;
            document.getElementById('progress-display').innerText = `é¡Œç›®: ${currentQuestionIndex + 1} / ${TOTAL_QUESTIONS_PER_ROUND}`;
        }

        function endGame() {
            showScreen('result-screen');
            const finalScore = (currentScore / TOTAL_QUESTIONS_PER_ROUND) * 100;
            document.getElementById('final-score-text').innerText = Math.round(finalScore);
            let comment = finalScore === 100 ? "å¤ªå²å®³äº†ï¼" : "è¡¨ç¾å¾ˆæ£’å–”ï¼";
            speakSimple(`æŒ‘æˆ°å®Œæˆï¼Œ${comment}`);
        }

        function generateQuestion() {
            if (currentQuestionIndex >= TOTAL_QUESTIONS_PER_ROUND) {
                endGame();
                return;
            }

            updateStatusBar();
            synth.cancel();

            const displayArea = document.getElementById('display-area');
            const optionsArea = document.getElementById('options-area');
            const feedback = document.getElementById('feedback');
            
            displayArea.innerHTML = '';
            optionsArea.innerHTML = '';
            feedback.className = '';
            feedback.innerText = 'è«‹ç”¨æ‰‹é»ä¸€é»ï¼Œæ•¸æ•¸çœ‹æœ‰å¤šå°‘ï¼Ÿ';
            feedback.style.color = '#333';
            
            isSystemGuiding = false;
            isAnswered = false;
            isRetryMode = false;
            userClickCount = 0;

            currentCount = Math.floor(Math.random() * (currentLevelMax - currentLevelMin + 1)) + currentLevelMin;

            const categoryKeys = Object.keys(categories);
            const randomCategory = categoryKeys[Math.floor(Math.random() * categoryKeys.length)];
            const items = categories[randomCategory];
            const randomItemChar = items[Math.floor(Math.random() * items.length)];

            // --- å›æ­¸ç´”ç²¹çš„è¿´åœˆç”Ÿæˆ (ç„¡ç¾¤çµ„æ¡†æ¡†) ---
            for (let i = 0; i < currentCount; i++) {
                const div = document.createElement('div');
                div.classList.add('item');
                div.innerText = randomItemChar;
                div.id = `item-${i}`;
                div.onclick = function() { handleUserTap(div); };
                displayArea.appendChild(div);
            }

            let options = [currentCount];
            while (options.length < 3) {
                let offset = Math.floor(Math.random() * 9) - 4;
                let wrongOption = currentCount + offset;
                if (wrongOption > 0 && !options.includes(wrongOption)) {
                    options.push(wrongOption);
                }
            }
            options.sort(() => Math.random() - 0.5);

            options.forEach(num => {
                const btn = document.createElement('button');
                btn.classList.add('option-btn');
                btn.innerText = num;
                btn.setAttribute('data-val', num);
                btn.onclick = () => checkAnswer(btn, num);
                optionsArea.appendChild(btn);
            });
        }

        function handleUserTap(item) {
            if (isAnswered || isSystemGuiding) return;

            if (!item.classList.contains('user-counted')) {
                userClickCount++;
                item.classList.add('user-counted');
                item.setAttribute('data-count', userClickCount);
                speakSimple(userClickCount.toString());
            }
        }

        function checkAnswer(btn, selectedNum) {
            if (isSystemGuiding) return;
            
            if (isAnswered && isRetryMode && selectedNum === currentCount) {
                handleCorrect(btn, false);
                return;
            }

            if (isAnswered) return;

            isAnswered = true; 

            if (selectedNum === currentCount) {
                handleCorrect(btn, true);
            } else {
                btn.classList.add('wrong');
                document.getElementById('feedback').innerText = 'ä¸å°å–”ï¼Œæˆ‘å€‘ä¸€èµ·ä¾†æ•¸æ•¸çœ‹ï¼';
                document.getElementById('feedback').style.color = '#dc3545';
                
                // èªéŸ³å®Œæ•´æ€§ç¢ºä¿æ©Ÿåˆ¶
                const errMsg = new SpeechSynthesisUtterance("ä¸å°å–”ï¼Œæˆ‘å€‘ä¸€èµ·ä¾†æ•¸æ•¸çœ‹");
                errMsg.lang = 'zh-TW';
                
                synth.cancel();
                
                errMsg.onend = function() {
                    startGuidedCounting();
                };
                
                synth.speak(errMsg);
                
                const allItems = document.querySelectorAll('.item');
                allItems.forEach(item => {
                    item.classList.remove('user-counted');
                    item.removeAttribute('data-count');
                });
            }
        }

        function handleCorrect(btn, addScore) {
            const feedback = document.getElementById('feedback');
            
            btn.classList.remove('suggest-correct');
            btn.classList.add('correct');
            
            feedback.innerText = 'å¤ªæ£’äº†ï¼ç­”å°äº†ï¼';
            feedback.style.color = 'green';
            
            if (addScore) currentScore++;
            
            speakSimple("å¤ªæ£’äº†ï¼Œç­”å°äº†");
            
            setTimeout(() => {
                currentQuestionIndex++;
                generateQuestion();
            }, 1500);
        }

        function startGuidedCounting() {
            isSystemGuiding = true;
            
            const buttons = document.querySelectorAll('.option-btn');
            const feedback = document.getElementById('feedback');
            
            buttons.forEach(b => b.disabled = true);
            feedback.classList.add('feedback-large');

            let count = 0;

            function playNext() {
                if (count >= currentCount) {
                    finishCounting();
                    return;
                }

                const currentItem = document.getElementById(`item-${count}`);
                if (currentItem) {
                    currentItem.classList.add('counting-highlight');
                    currentItem.setAttribute('data-count', count + 1);
                    // é€™è£¡å¯ä»¥è¦–æƒ…æ³é–‹å•Ÿï¼Œå¦‚æœè¢å¹•å¤ å¤§å¯èƒ½ä¸éœ€è¦
                    // currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }

                feedback.innerText = count + 1;

                const utterance = new SpeechSynthesisUtterance((count + 1).toString());
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;

                utterance.onend = function() {
                    if (currentItem) {
                        currentItem.classList.remove('counting-highlight');
                    }
                    count++;
                    setTimeout(playNext, 100);
                };

                synth.speak(utterance);
            }

            playNext();
            
            function finishCounting() {
                isSystemGuiding = false;
                isRetryMode = true;
                
                feedback.classList.remove('feedback-large');
                feedback.innerText = `å…±æœ‰ ${currentCount} å€‹ï¼Œè«‹é¸å‡ºæ­£ç¢ºçš„ç­”æ¡ˆï¼`;
                
                const finalMsg = new SpeechSynthesisUtterance(`å…±æœ‰ ${currentCount} å€‹ï¼Œè«‹é¸å‡ºæ­£ç¢ºçš„ç­”æ¡ˆ`);
                finalMsg.lang = 'zh-TW';
                synth.speak(finalMsg);

                buttons.forEach(b => {
                    const btnVal = parseInt(b.getAttribute('data-val'));
                    if (btnVal === currentCount) {
                        b.disabled = false;
                        b.classList.add('suggest-correct');
                    } else {
                        b.disabled = true;
                        b.style.opacity = '0.3';
                    }
                });
            }
        }

        function speakSimple(text) {
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            synth.speak(utterance);
        }

        window.onload = showMenu;

    </script>
</body>
</html>